<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DELTARUNEWeb OST Player!</title>
    <base href="https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/fav.ico" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
      :root {
        --primary-bg: rgba(0, 0, 0, 0.75);
        --secondary-bg: rgba(28, 28, 28, 0.85);
        --accent-color: #FFFFFF;
        --text-color: #FFFFFF;
        --text-secondary: #b3b3b3;
      }

      @font-face {
        font-family: "Determination";
        src: url("https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/fonts/8bitOperatorPlus-Bold.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000;
        font-family: "Determination", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        font-size: 13.2px;
      }

      .fullscreen-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100vw;
        height: 100vh;
      }

      .music-player-container {
        width: 100%;
        height: 100%;
        background-color: var(--primary-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      #background-gif {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/bg.gif');
        background-size: cover;
        background-position: center;
        opacity: 0;
        transition: opacity 0.25s ease-in-out;
        pointer-events: none;
        z-index: 1;
      }

      .scrollable {
        scrollbar-width: none;
      }

      .scrollable::-webkit-scrollbar {
        display: none;
      }

      .view {
        flex-grow: 1;
        overflow-y: auto;
        padding: 30px;
        display: none;
        flex-direction: column;
        width: 100%;
        box-sizing: border-box;
        position: relative;
        z-index: 2;
      }

      .view.active {
        display: flex;
      }

      #song-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      #song-list-header h2 {
        color: var(--text-color);
        margin: 0;
        font-size: 2em;
      }

      #sort-controls button {
        background: var(--secondary-bg);
        border: 1px solid #333;
        color: var(--text-secondary);
        padding: 5px 10px;
        margin-left: 5px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
      }

      #sort-controls button:hover,
      #sort-controls button.active {
        background: var(--accent-color);
        color: var(--primary-bg);
      }

      .song-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        padding: 10px 5px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        transition: background-color 0.2s;
      }

      .song-item:hover {
        background-color: var(--secondary-bg);
      }

      .song-item-cover {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
        background-color: #2a2a2a;
      }

      .song-item .title {
        color: var(--text-color);
        font-size: 1.1em;
      }

      .song-item .artist {
        color: var(--text-secondary);
        font-size: 0.9em;
      }

      .song-item-left {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
        min-width: 0;
      }

      .song-item-album {
        white-space: normal !important;
        overflow: visible !important;
        max-width: 200px;
        text-align: right;
        margin-right: 10px;
        color: var(--text-secondary);
      }

      #player-album {
        color: var(--text-secondary);
        margin: -5px 0 10px 0;
        font-size: 1.0em;
      }

      .album-prefix {
        font-size: 0.8em;
      }

      #player-view {
        justify-content: center;
        align-items: center;
        gap: 1.5vh;
      }

      #player-content-wrapper {
        width: 80%;
        max-width: 400px;
      }

      #player-album-cover {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        margin-bottom: 20px;
        background-color: var(--secondary-bg);
      }

      #player-info {
        width: 100%;
        text-align: left;
      }

      #player-info h3 {
        color: var(--text-color);
        margin: 0 0 5px;
        font-size: 2em;
      }

      #player-info p {
        color: var(--text-secondary);
        margin: 0 0 6px;
        font-size: 1.2em;
      }

      .playback-controls {
        width: 80%;
        max-width: 400px;
      }

      .progress-container {
        width: 100%;
        margin: 10px 0;
        cursor: pointer;
        background-color: #404040;
        height: 6px;
        border-radius: 6px;
      }

      .progress-bar {
        background-color: var(--accent-color);
        width: 0%;
        height: 100%;
        border-radius: 6px;
      }

      .time-stamps {
        display: flex;
        justify-content: space-between;
        width: 100%;
        color: var(--text-secondary);
        font-size: 0.9em;
        margin-bottom: 10px;
      }

      .controls {
        display: flex;
        align-items: center;
        justify-content: space-around;
        width: 100%;
      }

      .control-btn-img {
        cursor: pointer;
        transition: transform 0.2s, filter 0.2s;
        height: 1.8em;
        width: auto;
        filter: brightness(0.7);
      }

      .control-btn-img.active {
        filter: brightness(1.2) drop-shadow(0 0 4px var(--accent-color));
      }

      .control-btn-img:hover {
        filter: brightness(1);
      }

      #play-pause-btn-img {
        height: 40px;
        width: 40px;
        filter: brightness(0.85);
      }

      #play-pause-btn-img:hover {
        transform: scale(1.05);
      }

      #back-to-list-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 2em;
        cursor: pointer;
        z-index: 10;
      }

      #back-to-list-btn:hover {
        color: var(--text-color);
      }

      #mini-player {
        background-color: var(--secondary-bg);
        padding: 10px 20px;
        display: none;
        flex-direction: column;
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        box-sizing: border-box;
        border-top: 1px solid #333;
        z-index: 5;
      }

      #mini-player.visible {
        display: flex;
      }

      #mini-progress-container {
        position: relative;
        width: calc(100% + 40px);
        height: 6px;
        margin: -10px -20px 10px -20px;
        cursor: pointer;
        background-color: #404040;
        display: flex;
        align-items: center;
      }

      #mini-progress-bar {
        position: absolute;
        background-color: var(--accent-color);
        width: 0%;
        height: 100%;
        border-radius: 6px;
        pointer-events: none;
      }

      .mini-hover-timestamp {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-color);
        background: rgba(0, 0, 0, 0.6);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease-in-out;
        z-index: 2;
        pointer-events: none;
      }

      #mini-progress-container:hover .mini-hover-timestamp {
        opacity: 1;
        visibility: visible;
      }

      #mini-hover-time {
        left: 10px;
      }

      #mini-hover-duration {
        right: 10px;
      }

      .mini-player-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      .mini-player-left {
        display: flex;
        align-items: center;
        gap: 15px;
        cursor: pointer;
        flex: 1;
        min-width: 0;
      }

      #mini-player-cover {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        background-color: var(--secondary-bg);
        flex-shrink: 0;
      }

      #mini-player .song-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #mini-player-title {
        color: var(--text-color);
        font-size: 1em;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #mini-player-artist {
        color: var(--text-secondary);
        font-size: 0.8em;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #mini-player .controls {
        gap: 20px;
        justify-content: flex-end;
        flex-shrink: 0;
        width: auto;
      }

      #mini-player .control-btn-img {
        height: 1.2em;
      }

      #sorting-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sort-label {
        color: var(--text-secondary);
        font-size: 0.9em;
      }

      #song-list-view.has-mini-player {
        padding-bottom: 70px;
      }

      #album-art-container {
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        overflow: hidden;
      }

      #album-gif-overlay {
        width: 100%;
        object-fit: contain;
      }

      #player-album-cover {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .song-item.playing,
      .song-item.playing:hover {
        background-color: rgba(59, 130, 246, 0.25);
        border-left: 3px solid #3B82F6;
        padding-left: 12px;
      }

      .song-item.playing .title {
        color: #60A5FA;
        font-weight: bold;
      }

      @media (max-width: 768px) {
        .view {
          padding: 20px;
        }

        #song-list-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }

        #song-list-header h2 {
          font-size: 1.5em;
        }

        #player-content-wrapper,
        .playback-controls {
          width: 90%;
        }

        #player-info h3 {
          font-size: 1.5em;
        }

        #player-info p {
          font-size: 1em;
        }

        .song-item-album {
          white-space: normal !important;
          overflow: visible !important;
          max-width: 200px;
          text-align: right;
          margin-right: 10px;
          color: var(--text-secondary);
        }

        .controls {
          gap: 10px;
          justify-content: space-between;
        }

        #mini-player .controls {
          gap: 15px;
        }

        .song-duration {
          font-size: 1.1em;
          /* slightly bigger than album text */
          color: #dddddd !important;
          margin-left: 4px;
        }

        .song-item-details-extended {
          display: flex;
          flex-direction: column;
        }

        .song-item-details-extended .title {
          color: var(--text-color);
          font-size: 1.1em;
        }

        .song-item-details-extended .song-duration {
          color: var(--text-secondary);
          font-size: 0.9em;
          margin-top: 2px;
        }
      }
    </style>
  </head>
  <body>
    <div class="fullscreen-wrapper">
      <div class="music-player-container">
        <div id="background-gif"></div>
        <div id="song-list-view" class="view active scrollable">
          <div id="song-list-header">
            <h2>DELTARUNE Chapters 1-4 (Original Game Soundtrack)</h2>
            <div id="sorting-container">
              <span class="sort-label">Sort by:</span>
              <div id="sort-controls">
                <button id="sort-queue" style="display: none;">Queue</button>
                <button id="sort-album-track" class="active">Album</button>
                <button id="sort-alpha">A-Z</button>
                <button id="sort-duration">Duration</button>
              </div>
            </div>
          </div>
          <div id="song-list">
            <p style="color: var(--text-secondary);">Loading playlist...</p>
          </div>
        </div>
        <div id="player-view" class="view">
          <button id="back-to-list-btn" title="Back to list">&#10094;</button>
          <div id="player-content-wrapper">
            <div id="album-art-container">
              <img src="https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/sweetcapncakes.png" id="album-gif-overlay">
              <img src="https://placehold.co/300x300/000000/FFFFFF?text=Album+Art" alt="Album Cover" id="player-album-cover">
            </div>
            <div id="player-info">
              <h3 id="player-title">Song Title</h3>
              <p id="player-artist">Artist</p>
              <p id="player-album">Album</p>
            </div>
          </div>
          <div class="playback-controls">
            <div class="progress-container" id="progress-container">
              <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="time-stamps">
              <span id="current-time">0:00</span>
              <span id="duration">0:00</span>
            </div>
            <div class="controls">
              <img src="" alt="Shuffle" class="control-btn-img" id="shuffle-btn-img">
              <img src="" alt="Previous" class="control-btn-img" id="prev-btn-img">
              <img src="" alt="Play" class="control-btn-img" id="play-pause-btn-img">
              <img src="" alt="Next" class="control-btn-img" id="next-btn-img">
              <img src="" alt="Loop" class="control-btn-img" id="loop-btn-img">
            </div>
          </div>
        </div>
        <div id="mini-player">
          <div id="mini-progress-container" class="progress-container">
            <span id="mini-hover-time" class="mini-hover-timestamp">0:00</span>
            <div id="mini-progress-bar" class="progress-bar"></div>
            <span id="mini-hover-duration" class="mini-hover-timestamp">3:00</span>
          </div>
          <div class="mini-player-content">
            <div class="mini-player-left">
              <img src="https://placehold.co/40x40/1c1c1c/FFFFFF?text=Art" alt="Album Cover" id="mini-player-cover">
              <div class="song-info">
                <div id="mini-player-title">Song Title</div>
                <div id="mini-player-artist">Artist</div>
              </div>
            </div>
            <div class="controls">
              <img src="" alt="Shuffle" class="control-btn-img" id="mini-shuffle-btn-img">
              <img src="" alt="Previous" class="control-btn-img" id="mini-prev-btn-img">
              <img src="" alt="Play" class="control-btn-img" id="mini-play-pause-btn-img">
              <img src="" alt="Next" class="control-btn-img" id="mini-next-btn-img">
              <img src="" alt="Loop" class="control-btn-img" id="mini-loop-btn-img">
            </div>
          </div>
        </div>
        <audio id="audio-source"></audio>
      </div>
    </div>
    <script>
      let hasPlayedThisSession = false;
      const buttonImages = {
          play: 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/play.png',
          pause: 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/pause.png',
          next: 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/next.png',
          prev: 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/prev.png',
          shuffle_on: 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/onshuffle.png',
          shuffle_off: 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/shuffle.png',
          loop_none: 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/loop.png',
          loop_one: 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/oneloop.png',
          loop_all: 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/onloop.png'
      };
        const animatedGifSrc = 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/sweetcapncakes.gif';
        const pausedGifSrc = 'https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/sweetcapncakes.png';
      let masterSongList = [];
      let songs = [];
      let currentSongIndex = 0;
      let isPlaying = false;
      let isShuffling = false;
      let loopMode = 'none';
      let currentSort = 'albumTrack';
      let playbackQueue = [];
      let previousQueue = [];
      let nextQueue = [];
      let isFirstQueue = true;
      let hasSeenPlayer = false;
      const placeholderCover = 'https://placehold.co/300x300/000000/FFFFFF?text=No+Art';
      const audio = document.getElementById('audio-source');
      const songList = document.getElementById('song-list');
      const playerView = document.getElementById('player-view');
      const albumArtContainer = document.getElementById('album-art-container');
      const albumGifOverlay = document.getElementById('album-gif-overlay');
      const songListView = document.getElementById('song-list-view');
      const miniPlayer = document.getElementById('mini-player');
      const backgroundGif = document.getElementById('background-gif');
      const playerAlbumCover = document.getElementById('player-album-cover');
      const playerTitle = document.getElementById('player-title');
      const playerArtist = document.getElementById('player-artist');
      const playerAlbum = document.getElementById('player-album');
      const shuffleBtnImg = document.getElementById('shuffle-btn-img');
      const prevBtnImg = document.getElementById('prev-btn-img');
      const playPauseBtnImg = document.getElementById('play-pause-btn-img');
      const nextBtnImg = document.getElementById('next-btn-img');
      const loopBtnImg = document.getElementById('loop-btn-img');
      const miniShuffleBtnImg = document.getElementById('mini-shuffle-btn-img');
      const miniPrevBtnImg = document.getElementById('mini-prev-btn-img');
      const miniPlayPauseBtnImg = document.getElementById('mini-play-pause-btn-img');
      const miniNextBtnImg = document.getElementById('mini-next-btn-img');
      const miniLoopBtnImg = document.getElementById('mini-loop-btn-img');
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const currentTimeEl = document.getElementById('current-time');
      const durationEl = document.getElementById('duration');
      const backToListBtn = document.getElementById('back-to-list-btn');
      const miniPlayerLeft = document.querySelector('.mini-player-left');
      const miniPlayerCover = document.getElementById('mini-player-cover');
      const miniPlayerTitle = document.getElementById('mini-player-title');
      const miniPlayerArtist = document.getElementById('mini-player-artist');
      const miniHoverTime = document.getElementById('mini-hover-time');
      const miniHoverDuration = document.getElementById('mini-hover-duration');
      const miniProgressContainer = document.getElementById('mini-progress-container');
      const miniProgressBar = document.getElementById('mini-progress-bar');

      function formatArtists(artistString) {
        if (!artistString || !artistString.includes('/')) {
          return artistString;
        }
        const artists = artistString.split('/').map(name => name.trim());
        if (artists.length === 1) {
          return artists[0];
        } else if (artists.length === 2) {
          return artists.join(' & ');
        } else {
          const lastArtist = artists.pop();
          return `${artists.join(', ')} & ${lastArtist}`;
        }
      }
      async function loadPlaylist() {
        try {
          const response = await fetch('https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/mus/list.txt');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const text = await response.text();
          const filenames = text.split('\n').filter(line => line.trim() !== '');
          if (filenames.length === 0) {
            displayError("Playlist file is empty.");
            return;
          }
          songList.innerHTML = `

                                                                        
                                                                        
                                                                        
                                                                        <p style="color: var(--text-secondary);">Loading songs... 
                                                                            <br> (0/${filenames.length} loaded)
                                                                            </p>`;
          const songPromises = filenames.map(async (filename, index) => {
            const trimmedFilename = filename.trim();
            const metadataUrl = `https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/mus/${trimmedFilename}`;
            const audioSrc = `https://cdn.jsdelivr.net/gh/keucherenthusiast4784/9326265e4f1b14345a3bdab6f8ffad0e2e7ab3fda920c5f0f095f77359af00aeae22591c5bc4914c84c13d99eb62091d7ce7@main/drweb/music/mus/${trimmedFilename}`;
            const [metadata, duration] = await Promise.all([
              getSongMetadata(metadataUrl, audioSrc),
              getSongDuration(audioSrc)
            ]);
            metadata.duration = duration;
            songList.innerHTML = `

                                                                        
                                                                        
                                                                        
                                                                            <p style="color: var(--text-secondary);">Loading songs... 
                                                                                <br> (${index + 1}/${filenames.length} loaded)
                                                                                </p>`;
            return metadata;
          });
          masterSongList = await Promise.all(songPromises);
          applySort(currentSort);
          initializePlayer();
        } catch (error) {
          console.error("Error loading playlist:", error);
          displayError("Could not load 'list.txt'.");
        }
      }

      function updateMinibar() {
        if (!playbackQueue[currentSongIndex]) return;
        const song = playbackQueue[currentSongIndex];
        miniPlayerCover.src = song.cover || placeholderCover;
        miniPlayerTitle.textContent = song.title;
        miniPlayerArtist.textContent = formatArtists(song.artist);
        if (hasPlayedThisSession && !playerView.classList.contains('active')) {
          miniPlayer.classList.add('visible');
          songListView.classList.add('has-mini-player');
        } else {
          miniPlayer.classList.remove('visible');
          songListView.classList.remove('has-mini-player');
        }
      }

        function updatePlayingClass() {
            document.querySelectorAll('.song-item.playing').forEach(item => item.classList.remove('playing'));
            const currentSong = playbackQueue[currentSongIndex];
            if (!currentSong) return;
            const songItems = document.querySelectorAll('.song-item');
            songItems.forEach(item => {
                const title = item.querySelector('.title')?.textContent;
                const artist = item.querySelector('.artist')?.textContent;
                if (title === currentSong.title && artist === formatArtists(currentSong.artist)) {
                    item.classList.add('playing');
                    // optional: add paused class for styling if not playing
                    if (!isPlaying) {
                        item.classList.add('paused');
                    } else {
                        item.classList.remove('paused');
                    }
                }
            });
        }

      function filterAlbumName(albumTitle, context) {
        if (albumTitle.includes('Chapters 3+4')) {
          const mainText = "Chapters 3 + 4";
          if (context === 'player') {
            return `

                                                                        
                                                                        
                                                                        
                                                                                <span class="album-prefix">from</span> ${mainText}`;
          }
          return mainText;
        }
        const singleChapterMatch = albumTitle.match(/Chapter \d+/i);
        if (singleChapterMatch) {
          if (context === 'player') {
            return `

                                                                        
                                                                        
                                                                        
                                                                                <span class="album-prefix">from</span> ${singleChapterMatch[0]}`;
          }
          return singleChapterMatch[0];
        }
        return albumTitle;
      }

      function getSongMetadata(metadataUrl, audioSrc) {
        return fetch(audioSrc).then(res => res.blob()).then(blob => {
          return new Promise((resolve) => {
            window.jsmediatags.read(blob, {
              onSuccess: (tag) => {
                const {
                  title,
                  artist,
                  album,
                  track,
                  picture
                } = tag.tags;
                let cover = placeholderCover;
                if (picture) {
                  const uint8 = new Uint8Array(picture.data);
                  let binary = "";
                  uint8.forEach(byte => binary += String.fromCharCode(byte));
                  const base64String = btoa(binary);
                  cover = `data:${picture.format};base64,${base64String}`;
                }
                resolve({
                  title: title || metadataUrl.split('/').pop(),
                  artist: artist || '???',
                  album: album || '???',
                  track: parseInt(track) || 0,
                  src: audioSrc,
                  cover
                });
              },
              onError: () => {
                resolve({
                  title: metadataUrl.split('/').pop(),
                  artist: '???',
                  album: '???',
                  track: 0,
                  src: audioSrc,
                  cover: placeholderCover
                });
              }
            });
          });
        });
      }

      function getSongDuration(src) {
        return new Promise(resolve => {
          const tempAudio = new Audio();
          tempAudio.preload = 'metadata';
          tempAudio.src = src;
          tempAudio.addEventListener('loadedmetadata', () => resolve(tempAudio.duration));
          tempAudio.addEventListener('error', () => resolve(0));
        });
      }

      function applySort(criteria) {
        currentSort = criteria;
        const currentPlayingSrc = playbackQueue[currentSongIndex]?.src;
        let sortedList = [...masterSongList];
        sortedList.sort((a, b) => {
          if (criteria === 'alphabetical') {
            return a.title.localeCompare(b.title, undefined, {
              sensitivity: 'base'
            });
          }
          if (criteria === 'duration') {
            return a.duration - b.duration;
          }
          if (criteria === 'albumTrack') {
            const albumCompare = a.album.localeCompare(b.album, undefined, {
              sensitivity: 'base'
            });
            if (albumCompare !== 0) return albumCompare;
            return a.track - b.track;
          }
          return 0;
        });
        songs = sortedList;
        if (!isShuffling) {
          playbackQueue = [...songs];
          const newIndex = playbackQueue.findIndex(song => song.src === currentPlayingSrc);
          currentSongIndex = newIndex !== -1 ? newIndex : 0;
        }
        document.querySelectorAll('#sort-controls button').forEach(btn => btn.classList.remove('active'));
        let buttonId = '';
        if (criteria === 'albumTrack') buttonId = 'sort-album-track';
        else if (criteria === 'alphabetical') buttonId = 'sort-alpha';
        else if (criteria === 'duration') buttonId = 'sort-duration';
        else if (criteria === 'queue') buttonId = 'sort-queue';
        const sortButton = document.getElementById(buttonId);
        if (sortButton) sortButton.classList.add('active');
        loadSongList();
      }

      function shufflePlaylist() {
        let tempSongs = [...songs];
        for (let i = tempSongs.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [tempSongs[i], tempSongs[j]] = [tempSongs[j], tempSongs[i]];
        }
        songs = tempSongs;
      }

      function toggleShuffle() {
        isShuffling = !isShuffling;
        const queueButton = document.getElementById('sort-queue');
        if (isShuffling) {
          isFirstQueue = true;
          previousQueue = [];
          nextQueue = [];
          const currentlyPlayingSong = playbackQueue[currentSongIndex];
          let tempQueue = [...masterSongList];
          for (let i = tempQueue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [tempQueue[i], tempQueue[j]] = [tempQueue[j], tempQueue[i]];
          }
          playbackQueue = tempQueue;
          if (currentlyPlayingSong) {
            const idx = playbackQueue.findIndex(s => s.src === currentlyPlayingSong.src);
            if (idx > -1) {
              const [songToMove] = playbackQueue.splice(idx, 1);
              playbackQueue.unshift(songToMove);
            }
          }
          currentSongIndex = 0;
          songs = [...playbackQueue];
          queueButton.style.display = 'inline-block';
          document.querySelectorAll('#sort-controls button').forEach(btn => btn.classList.remove('active'));
          queueButton.classList.add('active');
        } else {
          const currentlyPlayingSong = playbackQueue[currentSongIndex];
          queueButton.style.display = 'none';
          applySort(currentSort);
          const newIndex = songs.findIndex(song => song.src === currentlyPlayingSong.src);
          currentSongIndex = newIndex !== -1 ? newIndex : 0;
        }
        loadSongList();
        updateShuffleButtons();
      }

      function cycleLoopMode() {
        if (loopMode === 'none') {
          loopMode = 'one';
          audio.loop = true;
        } else if (loopMode === 'one') {
          loopMode = 'all';
          audio.loop = false;
        } else {
          loopMode = 'none';
          audio.loop = false;
        }
        updateLoopButtons();
      }

      function updateShuffleButtons() {
        const shuffleButtons = [shuffleBtnImg, miniShuffleBtnImg];
        shuffleButtons.forEach(btn => {
          btn.src = isShuffling ? buttonImages.shuffle_on : buttonImages.shuffle_off;
          isShuffling ? btn.classList.add('active') : btn.classList.remove('active');
        });
      }

      function updateLoopButtons() {
        const loopButtons = [loopBtnImg, miniLoopBtnImg];
        loopButtons.forEach(btn => {
          btn.classList.remove('active');
          if (loopMode === 'one') {
            btn.src = buttonImages.loop_one;
            btn.classList.add('active');
          } else if (loopMode === 'all') {
            btn.src = buttonImages.loop_all;
            btn.classList.add('active');
          } else {
            btn.src = buttonImages.loop_none;
          }
        });
      }

      function onSongEnd() {
        nextSong();
      }

      function displayError(message) {
        songList.innerHTML = `

                                                                        
                                                                        
                                                                        
                                                                                <p style="color: var(--text-secondary); padding: 10px;">${message}</p>`;
        playerTitle.textContent = "Error";
        playerArtist.textContent = "Could not load playlist.";
      }

      function initializePlayer() {
        if (masterSongList.length > 0) {
          playbackQueue = [...songs];
          loadSongList();
          loadSong(songs[currentSongIndex]);
        } else {
          displayError("No valid songs found in playlist.");
        }
      }

      function loadSongList() {
        songList.innerHTML = '';
        songs.forEach((song, index) => {
          const songItem = document.createElement('div');
          songItem.classList.add('song-item');
          songItem.innerHTML = `
              
                                                                        
                                                                                <div class="song-item-left">
                                                                                    <img src="${song.cover}" alt="${song.title} cover" class="song-item-cover">
                                                                                        <div class="song-item-details">
                                                                                            <div class="title">${song.title}</div>
                                                                                            <div class="artist">${formatArtists(song.artist)}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="song-item-album">
                ${filterAlbumName(song.album, 'list')}
                
                                                                                
                                                                                        <div class="song-duration">${formatTime(song.duration)}</div>
                                                                                    </div>
          `;
          songItem.addEventListener('click', () => {
            const clickedSong = songs[index];
            if (isShuffling) {
              let tempQueue = masterSongList.filter(s => s.src !== clickedSong.src);
              for (let i = tempQueue.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tempQueue[i], tempQueue[j]] = [tempQueue[j], tempQueue[i]];
              }
              playbackQueue = [clickedSong, ...tempQueue];
              currentSongIndex = 0;
            } else {
              currentSongIndex = playbackQueue.findIndex(s => s.src === clickedSong.src);
            }
            loadSong(playbackQueue[currentSongIndex]);
            playSong();
            updateMinibar();
            updatePlayingClass();
          });
          songList.appendChild(songItem);
        });
        updatePlayingClass();
      }

      function loadSong(song) {
        audio.src = song.src;
        playerAlbumCover.src = song.cover;
        playerTitle.textContent = song.title;
        playerArtist.textContent = formatArtists(song.artist);
        playerAlbum.innerHTML = filterAlbumName(song.album, 'player');
        miniPlayerCover.src = song.cover;
        miniPlayerTitle.textContent = song.title;
        miniPlayerArtist.textContent = formatArtists(song.artist);
        if ('mediaSession' in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: song.title,
            artist: formatArtists(song.artist),
            album: `DELTARUNE ${filterAlbumName(song.album, 'list')}`,
            artwork: [{
              src: song.cover,
              sizes: '300x300',
              type: 'image/png'
            }, ]
          });
        }
      }

      function setButtonImages() {
        prevBtnImg.src = buttonImages.prev;
        miniPrevBtnImg.src = buttonImages.prev;
        nextBtnImg.src = buttonImages.next;
        miniNextBtnImg.src = buttonImages.next;
        playPauseBtnImg.src = isPlaying ? buttonImages.pause : buttonImages.play;
        miniPlayPauseBtnImg.src = isPlaying ? buttonImages.pause : buttonImages.play;
        updateShuffleButtons();
        updateLoopButtons();
      }

      function resumeSong() {
        if (playbackQueue.length === 0) return;
        const song = playbackQueue[currentSongIndex];
        if (!song) return;
        audio.play().catch(e => console.error("Play error:", e));
        isPlaying = true;
        document.title = `${song.title}／${formatArtists(song.artist)}`;
        playPauseBtnImg.src = buttonImages.pause;
        miniPlayPauseBtnImg.src = buttonImages.pause;
        albumGifOverlay.src = animatedGifSrc;
        backgroundGif.style.opacity = "0.75";
        updatePlayingClass();
        updateMinibar();
      }

      function playSong() {
          if (!hasPlayedThisSession) {
              switchToPlayerView();
            }
        hasPlayedThisSession = true;
        if (playbackQueue.length === 0) return;
        const song = playbackQueue[currentSongIndex];
        albumGifOverlay.src = animatedGifSrc;
        isPlaying = true;
        document.title = `${song.title}／${formatArtists(song.artist)}`;
        loadSong(song);
        audio.play().catch(e => console.error("Play error:", e));
        playPauseBtnImg.src = buttonImages.pause;
        miniPlayPauseBtnImg.src = buttonImages.pause;
        backgroundGif.style.opacity = '0.75';
        updatePlayingClass();
      }

      function pauseSong() {
        albumGifOverlay.src = pausedGifSrc;
        isPlaying = false;
        document.title = "DELTARUNEWeb OST Player!";
        audio.pause();
        playPauseBtnImg.src = buttonImages.play;
        miniPlayPauseBtnImg.src = buttonImages.play;
        backgroundGif.style.opacity = '0';
        updatePlayingClass();
      }

      function prevSong() {
        if (playbackQueue.length === 0) return;
        if (audio.currentTime > 2) {
          audio.currentTime = 0;
          return;
        }
        if (isShuffling && currentSongIndex === 0) {
          if (isFirstQueue) {
            audio.currentTime = 0;
            return;
          } else {
            nextQueue = [...playbackQueue];
            playbackQueue = [...previousQueue];
            previousQueue = [];
            isFirstQueue = true;
            currentSongIndex = playbackQueue.length - 1;
            if (document.getElementById('sort-queue').classList.contains('active')) {
              songs = [...playbackQueue];
              loadSongList();
            }
          }
        } else {
          currentSongIndex = (currentSongIndex - 1 + playbackQueue.length) % playbackQueue.length;
        }
        loadSong(playbackQueue[currentSongIndex]);
        playSong();
      }

      function nextSong() {
        updateMinibar();
        if (playbackQueue.length === 0) return;
        if (isShuffling && currentSongIndex === playbackQueue.length - 1) {
          previousQueue = [...playbackQueue];
          isFirstQueue = false;
          if (nextQueue.length > 0) {
            playbackQueue = [...nextQueue];
            nextQueue = [];
          } else {
            let tempQueue = [...masterSongList];
            for (let i = tempQueue.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [tempQueue[i], tempQueue[j]] = [tempQueue[j], tempQueue[i]];
            }
            playbackQueue = tempQueue;
          }
          currentSongIndex = 0;
          if (document.getElementById('sort-queue').classList.contains('active')) {
            songs = [...playbackQueue];
            loadSongList();
          }
        } else if (loopMode !== 'all' && !isShuffling && currentSongIndex === playbackQueue.length - 1) {
          pauseSong();
          return;
        } else {
          currentSongIndex = (currentSongIndex + 1) % playbackQueue.length;
        }
        loadSong(playbackQueue[currentSongIndex]);
        playSong();
      }

      function updateProgress(e) {
        const {
          duration,
          currentTime
        } = e.srcElement;
        if (duration) {
          const progressPercent = (currentTime / duration) * 100;
          progressBar.style.width = `${progressPercent}%`;
          miniProgressBar.style.width = `${progressPercent}%`;
          const formattedCurrentTime = formatTime(currentTime);
          const formattedDuration = formatTime(duration);
          currentTimeEl.textContent = formattedCurrentTime;
          durationEl.textContent = formattedDuration;
          miniHoverTime.textContent = formattedCurrentTime;
          miniHoverDuration.textContent = formattedDuration;
        }
      }

      function setMiniProgress(e) {
        const width = this.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        if (duration) {
          audio.currentTime = (clickX / width) * duration;
        }
      }

      function setProgress(e) {
        const width = this.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        if (duration) {
          audio.currentTime = (clickX / width) * duration;
        }
      }

      function formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
      }

      function switchToPlayerView() {
        songListView.classList.remove('active');
        playerView.classList.add('active');
        miniPlayer.classList.remove('visible');
        songListView.classList.remove('has-mini-player');
        hasSeenPlayer = true;
      }

      function switchToListView() {
        playerView.classList.remove('active');
        songListView.classList.add('active');
        if (audio.src && !audio.paused) {
          miniPlayer.classList.add('visible');
          songListView.classList.add('has-mini-player');
        } else {
          miniPlayer.classList.remove('visible');
          songListView.classList.remove('has-mini-player');
        }
      }
      [playPauseBtnImg, miniPlayPauseBtnImg].forEach(btn => {
        btn.addEventListener('click', () => {
          if (!audio.src || songs.length === 0) return;
          isPlaying ? pauseSong() : resumeSong();
        });
      });
      [prevBtnImg, miniPrevBtnImg].forEach(btn => btn.addEventListener('click', prevSong));
      [nextBtnImg, miniNextBtnImg].forEach(btn => btn.addEventListener('click', nextSong));
      audio.addEventListener('timeupdate', updateProgress);
      audio.addEventListener('ended', onSongEnd);
      progressContainer.addEventListener('click', setProgress);
      miniProgressContainer.addEventListener('click', setMiniProgress);
      backToListBtn.addEventListener('click', switchToListView);
      miniPlayerLeft.addEventListener('click', switchToPlayerView);
      [shuffleBtnImg, miniShuffleBtnImg].forEach(btn => btn.addEventListener('click', toggleShuffle));
      [loopBtnImg, miniLoopBtnImg].forEach(btn => btn.addEventListener('click', cycleLoopMode));
      document.getElementById('sort-album-track').addEventListener('click', () => applySort('albumTrack'));
      document.getElementById('sort-alpha').addEventListener('click', () => applySort('alphabetical'));
      document.getElementById('sort-duration').addEventListener('click', () => applySort('duration'));
      document.getElementById('sort-queue').addEventListener('click', () => {
        songs = [...playbackQueue];
        document.querySelectorAll('#sort-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('sort-queue').classList.add('active');
        loadSongList();
      });
      document.addEventListener('DOMContentLoaded', () => {
        setButtonImages();
        loadPlaylist();
        if ('mediaSession' in navigator) {
          navigator.mediaSession.setActionHandler('play', () => resumeSong());
          navigator.mediaSession.setActionHandler('pause', () => pauseSong());
          navigator.mediaSession.setActionHandler('previoustrack', () => prevSong());
          navigator.mediaSession.setActionHandler('nexttrack', () => nextSong());
        }
      });
    </script>
  </body>
</html>
<!-- DELTARUNEWeb v5.0 -->
<!-- made with ❤️ by .shortpie. -->
<!-- credits to Toby Fox for making DELTARUNE, we love you! -->
